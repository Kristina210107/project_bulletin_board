<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Профиль — ТовароОбмен</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Стили для переключения страниц */
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }

        /* Стили для авторизации */
        .auth-page {
            max-width: 420px;
            margin: 36px auto;
            padding: 18px;
            background: var(--card);
            border-radius: 12px;
        }
        .auth-page h2 {
            color: #331B15;
            margin-top: 0;
        }
        .input-group {
            position: relative;
            margin-bottom: 20px;
        }
        
        .input-group .input {
            width: 100%;
            padding: 14px 12px 14px 12px;
            border: 1px solid var(--card-border);
            border-radius: 10px;
            background: var(--secondary-bg);
            color: var(--main-text);
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s;
            outline: none;
        }
        
        .input-group .input:focus {
            border-color: var(--primary-bg);
            box-shadow: 0 0 0 3px rgba(245,160,137,0.2);
        }
        
        .input-group .floating-label {
            position: absolute;
            left: 12px;
            top: 14px;
            color: var(--muted);
            font-size: 15px;
            font-weight: 400;
            pointer-events: none;
            transition: all 0.2s;
        }
        
        .input-group .input:focus + .floating-label,
        .input-group .input:not(:placeholder-shown) + .floating-label {
            top: -10px;
            left: 8px;
            font-size: 12px;
            font-weight: 500;
            background: var(--secondary-bg);
            padding: 0 4px;
            color: var(--primary-bg);
        }

        /* Стили для сообщений */
        .ms-root {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 12px;
            padding: 18px;
        }
        .conversations, .thread {
            background: var(--card);
            padding: 12px;
            border-radius: 12px;
        }
        .conv-item {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #fff;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.04);
        }
        .conv-item.active {
            background: linear-gradient(90deg, rgba(245,160,137,0.08), #fff);
        }
        .msg {
            padding: 8px;
            border-radius: 10px;
            margin: 6px 0;
            max-width: 70%;
        }
        .msg.you {
            background: var(--primary-bg);
            align-self: flex-end;
            color: var(--primary-text);
        }
        .msg.them {
            background: #fff;
            border: 1px solid rgba(0,0,0,0.04);
        }
        .composer {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .composer input {
            flex: 1;
        }

        /* Стили для страницы товара */
        .detail-layout {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 18px;
            align-items: start;
        }
        .detail-media {
            width: 360px;
            height: 300px;
            background: linear-gradient(180deg,#fbfbfb,#f2f6f2);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            overflow: hidden;
        }
        .detail-media img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Стили для аккаунта */
        .account-layout {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 18px;
            align-items: start;
        }

        /* Главная страница - исправленная сетка как на картинке */
        .main-layout {
            display: grid;
            grid-template-columns: 240px 1fr 260px;
            gap: 18px;
            align-items: start;
            padding: 18px;
        }

        /* Панель справа */
        .right-panel {
            background: var(--panel);
            padding: 14px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(12,18,12,0.03);
        }

        /* Карточки товаров в сетке */
        .offers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 14px;
        }

        /* Стили для запросов */
        .requests-panel {
            margin-bottom: 20px;
        }
        .request-item {
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.04);
        }
        .request-item strong {
            color: #331B15;
            display: block;
            margin-bottom: 4px;
        }
        .request-item small {
            color: var(--muted);
        }

        /* Истории обмена */
        .stories-panel {
            margin-top: 20px;
        }
        .story-item {
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.04);
        }

        /* Кнопки в правой панели */
        .panel-buttons {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .panel-button {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
        }
        .panel-button.primary {
            background: var(--primary-bg);
            color: var(--primary-text);
        }
        .panel-button.secondary {
            background: var(--secondary-bg);
            color: var(--secondary-text);
            border: 1px solid var(--secondary-border);
        }

        /* Адаптивность */
        @media (max-width: 980px) {
            .auth-page {
                max-width: 100%;
                width: calc(100% - 24px);
                margin: 16px auto;
                padding: 14px;
            }
            .ms-root, .detail-layout, .account-layout, .main-layout {
                grid-template-columns: 1fr;
                padding: 10px;
            }
            .detail-media {
                width: 100%;
                max-width: 100%;
                height: auto;
                max-height: 220px;
            }
            .offers-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <script src="/static/auth.js"></script>
    <!-- Страница профиля -->
    <div id="profile-page" class="page active">
        <header class="header">
            <div class="brand">
                <svg class="logo" width="72" height="72" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img">
                    <title>ТовароОбмен</title>
                    <circle cx="36" cy="36" r="34" fill="url(#g)" stroke="#795F58" stroke-width="2.5" />
                    <defs>
                        <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
                            <stop offset="0" stop-color="#F5A089"/>
                            <stop offset="1" stop-color="#CCA094"/>
                        </linearGradient>
                    </defs>
                    <g fill="none" stroke="#331B15" stroke-linecap="round" stroke-linejoin="round" stroke-width="6">
                        <path d="M22 24h28" />
                        <path d="M36 24v26" />
                    </g>
                </svg>
                <div>
                    <h1>ТовароОбмен</h1>
                    <p class="tag">Взаимная помощь. Реальные вещи. Достойные истории.</p>
                </div>
            </div>

            <div class="controls">
                <input id="global-search" class="header-search" placeholder="Поиск по всему сайту..." aria-label="Поиск"/>
                <div style="display:flex;gap:8px;align-items:center">
                    <button onclick="showPage('main-page')" class="auth" title="Главная">Главная</button>
                    <button onclick="showPage('messages-page')" class="auth" title="Сообщения">Сообщения</button>
                    <div class="auth-buttons" style="display:flex;gap:8px;align-items:center">
                        <a href="/web/auth" class="auth" id="login-btn">Войти</a>
                    </div>
                </div>

                <button onclick="showPage('profile-page')" style="text-decoration:none;color:inherit;background:none;border:none;cursor:pointer;" class="user" id="profile-btn" style="display:none;">
                    <div class="user" role="button" aria-label="Профиль">
                        <div class="avatar" id="user-avatar">А</div>
                        <div class="user-meta">
                            <div id="user-name">Анна</div>
                            <div class="score" id="user-score">Доверие: 4.4</div>
                        </div>
                    </div>
                </button>
            </div>
        </header>

        <div style="padding:18px;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px">
                <button onclick="showPage('main-page')" style="text-decoration:none;color:var(--menu-text);padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);background:var(--card);border:none;cursor:pointer;">← Вернуться</button>
                <h2 style="margin:0;font-size:20px;color:#331B15">Мой профиль</h2>
                <button onclick="showPage('messages-page')" style="text-decoration:none;color:var(--menu-text);padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);background:var(--card);border:none;cursor:pointer;">Перейти в сообщения</button>
            </div>

            <main class="account-layout">
                <section style="background:var(--card);padding:14px;border-radius:12px;">
                    <h3>Профиль</h3>
                    <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
                        <div style="width:72px;height:72px;border-radius:12px;background:#fff;display:grid;place-items:center;font-weight:700">А</div>
                        <div>
                            <div id="acc-name" style="font-weight:700;font-size:18px">Гость</div>
                            <div id="acc-email" style="color:var(--muted);font-size:13px">email@example.com</div>
                            <div id="acc-score" style="margin-top:6px;color:var(--muted)">Доверие: 0.0 • 0 сделок</div>
                        </div>
                    </div>

                    <div style="margin-top:12px">
                        <h4 style="margin:0 0 8px 0">Активность</h4>
                        <div id="acc-activity" style="display:flex;flex-direction:column;gap:8px"></div>
                    </div>
                </section>

                <aside style="background:var(--panel);padding:14px;border-radius:12px;">
                    <h4>Настройки</h4>
                    <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
                        <label>Имя <input id="input-name" class="input" placeholder="Ваше имя"/></label>
                        <label>Email <input id="input-email" class="input" placeholder="email@example.com"/></label>
                        <div style="display:flex;gap:8px">
                            <button id="save-profile" class="primary">Сохранить</button>
                            <button id="logout" class="save-btn">Выйти</button>
                        </div>
                    </div>
                </aside>
            </main>
        </div>
    </div>

    <!-- Страница сообщений -->
    <div id="messages-page" class="page">
        <div style="padding:12px;display:flex;justify-content:space-between;align-items:center">
            <button onclick="showPage('profile-page')" style="text-decoration:none;color:var(--menu-text);padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);background:var(--card);border:none;cursor:pointer;">← Вернуться</button>
            <h2 style="margin:0;color:#331B15">Сообщения</h2>
            <button onclick="showPage('profile-page')" style="text-decoration:none;color:var(--menu-text);padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);background:var(--card);border:none;cursor:pointer;">Мой профиль</button>
        </div>

        <div class="ms-root">
            <div class="conversations" id="conversations">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <strong>Чаты</strong>
                    <button id="new-chat" class="primary">Новый</button>
                </div>
                <div id="conv-list"></div>
            </div>

            <div class="thread" id="thread">
                <div id="thread-head" style="font-weight:700;color:#331B15;margin-bottom:8px">Выберите чат</div>
                <div id="messages" style="display:flex;flex-direction:column;min-height:360px;gap:4px;overflow:auto;padding-bottom:8px"></div>
                <div class="composer">
                    <input id="msg-input" class="input" placeholder="Написать сообщение..."/>
                    <button id="send-msg" class="primary">Отправить</button>
                </div>
            </div>
        </div>
    <script>
        // Простая функция переключения страниц
        function showPage(pageId) {
            // Скрыть все страницы
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            // Показать выбранную страницу
            document.getElementById(pageId).classList.add('active');

            // Обновить заголовок страницы
            const titles = {
                'main-page': 'ТовароОбмен — Сообщество обмена вещами',
                'product-page': 'Товар — ТовароОбмен',
                'messages-page': 'Сообщения — ТовароОбмен',
                'login-page': 'Вход — ТовароОбмен',
                'register-page': 'Регистрация — ТовароОбмен',
                'profile-page': 'Профиль — ТовароОбмен'
            };
            document.title = titles[pageId] || 'ТовароОбмен';
        }

        // Функция проверки авторизации пользователя
        async function checkAuthStatus() {
            try {
                const response = await fetch('/auth/me');
                const user = await response.json();
                
                if (response.ok && user) {
                    // Пользователь авторизован
                    document.getElementById('login-btn').style.display = 'none';
                    document.getElementById('profile-btn').style.display = 'flex';
                    
                    // Обновляем информацию о пользователе
                    document.getElementById('user-name').textContent = user.name || 'Пользователь';
                    document.getElementById('user-score').textContent = `Доверие: ${user.trust_score || '4.4'}`;
                } else {
                    // Пользователь не авторизован
                    document.getElementById('login-btn').style.display = 'block';
                    document.getElementById('profile-btn').style.display = 'none';
                }
            } catch (error) {
                // В случае ошибки считаем, что пользователь не авторизован
                document.getElementById('login-btn').style.display = 'block';
                document.getElementById('profile-btn').style.display = 'none';
            }
        }

        // Загружаем статус авторизации при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            
            // Привязываем обработчики форм авторизации
            bindAuthForms();
        });
    </script>
</body>
</html>